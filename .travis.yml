language: go 

go: 
    - 1.12.x

services: 
    - docker

sudo: true

before_install: 
    - go get -u golang.org/x/lint/golint
    - go get github.com/securego/gosec/cmd/gosec/...
    - go get golang.org/x/tools/cmd/goimports
    - go get -u github.com/golang/dep/cmd/dep
    - dep init
    - dep ensure

script:
    - gofmt -d ./
    - bash build/gofmt_check.sh

    - golint ./...

    - gosec ./...

    - goimports -d ./
    - bash build/goimports_check.sh

    - go test -race -coverprofile=coverage.out -covermode=atomic ./...

    - go build cmd/web-app/main.go

    - sudo docker build -f docker/web-app/Dockerfile -t "github-aggregator-web" . 

    - echo "$DOCKER_PASSWORD" | sudo docker login --username $DOCKER_LOGIN --password-stdin

    - sudo docker tag $DEFAULT_TAG $DOCKER_LOGIN/$DEFAULT_TAG

    - sudo docker push $DOCKER_LOGIN/$DEFAULT_TAG

after_success:
    - bash <(curl -s https://codecov.io/bash) 

    